<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>[Tutorial]: K8s Monitoring with InfluxDB's Telegraf |</title><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://astobbe.me/posts/k8s-monitoring-with-influx-telegraf/dashboard-memory-influx_hu662680d78e1d86c1cb7c0b4e329acc8b_819134_4095x0_resize_q100_box_3.png"><meta name=twitter:title content="[Tutorial]: K8s Monitoring with InfluxDB's Telegraf"><meta name=twitter:description content><meta name=twitter:creator content="@astobbe_"><meta name=Description content><meta property="og:title" content="[Tutorial]: K8s Monitoring with InfluxDB's Telegraf"><meta property="og:description" content="InfluxDB is an Open-Source timeseries database which can be used for monitoring Kubernetes clusters. In this tutorial, I want to show you step by step how to get a dashboard with metrics on Kuberntes resource usage of podes and nodes. It&rsquo;s not difficult, but the official documentation is outdated and confusing, so I hope to make it easier for you. We will use InfluxDB2 which includes a nice dashboard and supports the Flux QL query language."><meta property="og:type" content="article"><meta property="og:url" content="https://astobbe.me/posts/k8s-monitoring-with-influx-telegraf/"><meta property="og:image" content="https://astobbe.me/posts/k8s-monitoring-with-influx-telegraf/dashboard-memory-influx.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-04T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-04T00:00:00+00:00"><meta name=application-name content="Adrian's Site"><meta name=apple-mobile-web-app-title content="Adrian's Site"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=icon type=image/png sizes=192x192 href=/android-chrome-192x192.png><link rel=icon type=image/png sizes=512x512 href=/android-chrome-512x512.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://astobbe.me/posts/k8s-monitoring-with-influx-telegraf/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"[Tutorial]: K8s Monitoring with InfluxDB's Telegraf","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/astobbe.me\/posts\/k8s-monitoring-with-influx-telegraf\/"},"image":[{"@type":"ImageObject","url":"https:\/\/astobbe.me\/posts\/k8s-monitoring-with-influx-telegraf\/dashboard-memory-influx.png","width":6014,"height":3112}],"genre":"posts","wordCount":381,"url":"https:\/\/astobbe.me\/posts\/k8s-monitoring-with-influx-telegraf\/","datePublished":"2022-03-04T00:00:00+00:00","dateModified":"2022-03-04T00:00:00+00:00","description":""}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https:\/\/astobbe.me\/"},{"@type":"ListItem","position":2,"name":"Programming","item":"https://astobbe.me/categories/programming/"},{"@type":"ListItem","position":3,"name":"[Tutorial]: K8s Monitoring with InfluxDB\u0027s Telegraf"}]}</script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-3F6G2KTRL9"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3F6G2KTRL9")</script><body data-header-desktop data-header-mobile><script>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Adrian's Site" class="header-logo logo-svg">Adrian's Site</a></div><div class=menu><nav><ul class=menu-inner><li><a class=menu-item href=/posts/>Posts</a></li><li><a class=menu-item href=/categories/book-notes/>Book notes</a></li><li><a class=menu-item href=/categories/letters/>Letters</a></li><li><a class=menu-item href=/cv.astobbe.me>CV</a></li><li><a class=menu-item href=/now/>Now</a></li><li><a class=menu-item href=/about/>About</a></li></ul></nav><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><span class="svg-icon icon-search"></span></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><span class="svg-icon icon-cancel"></span></a>
<span class="search-button search-loading" id=search-loading-desktop><span class="svg-icon icon-loading"></span></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><span class="svg-icon icon-moon"></span></a></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Adrian's Site" class=header-logo>Adrian's Site</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><span class="svg-icon icon-search"></span></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><span class="svg-icon icon-cancel"></span></a>
<span class="search-button search-loading" id=search-loading-mobile><span class="svg-icon icon-loading"></span></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><nav><ul><li><a class=menu-item href=/posts/ title>Posts</a></li><li><a class=menu-item href=/categories/book-notes/ title>Book notes</a></li><li><a class=menu-item href=/categories/letters/ title>Letters</a></li><li><a class=menu-item href=/cv.astobbe.me title>CV</a></li><li><a class=menu-item href=/now/ title>Now</a></li><li><a class=menu-item href=/about/ title>About</a></li></ul></nav><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><span class="svg-icon icon-moon"></span></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class="container content-article theme-classic"><div class=toc id=toc-auto><div class=toc-title>Contents</div><div class=toc-content id=toc-content-auto></div></div><div class=header-post><div class=post-title><div class=post-all-meta><nav class=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/categories/programming/>Programming</a></li><li>[Tutorial]: K8s Monitoring with InfluxDB's Telegraf</li></ol></nav><h1 class="single-title flipInX">[Tutorial]: K8s Monitoring with InfluxDB's Telegraf</h1><div class=post-meta><div class=post-meta-line><span class=post-category><a href=/categories/programming/><i class="svg-icon icon-folder"></i>Programming</a>
</span><span class=post-meta-date><i class="svg-icon icon-clock"></i><time class=timeago datetime=2022-03-04>2022-03-04</time>
</span><span class=post-meta-words><i class="svg-icon icon-pencil"></i>381 words</span>
<span class=post-meta-reading><i class="svg-icon icon-stopwatch"></i>2 minutes</span></div></div></div></div></div><article class="single toc-start"><div class="content-block content-block-first content-block-position"><div class=post><div class=image-theme-classic><img src=https://astobbe.me/posts/k8s-monitoring-with-influx-telegraf/dashboard-memory-influx.png style=width:100%></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#1-download-helm-chart-repohttpsgithubcominfluxdatahelm-charts-and-add-to-helm>1. Download <a href=https://github.com/influxdata/helm-charts>helm chart repo</a> and add to helm:</a></li><li><a href=#2-deploy-influxdb2>2. Deploy Influxdb2</a></li><li><a href=#3-add-telegraf-configuration-in-influxdb>3. Add Telegraf Configuration in Influxdb</a></li><li><a href=#4-deploy-telegraf>4. Deploy Telegraf</a></li><li><a href=#5-view-metrics-data>5. View metrics data</a></li><li><a href=#6-connect-local-client-with-db>6. Connect local client with DB</a></li></ul></li></ul></nav></div></div><p>InfluxDB is an Open-Source timeseries database which can be used for monitoring Kubernetes clusters.
In this tutorial, I want to show you step by step how to get a dashboard with metrics on Kuberntes resource usage of podes and nodes. It&rsquo;s not difficult, but the official documentation is outdated and confusing, so I hope to make it easier for you.
We will use InfluxDB2 which includes a nice dashboard and supports the Flux QL query language.</p><h3 id=1-download-helm-chart-repohttpsgithubcominfluxdatahelm-charts-and-add-to-helm>1. Download <a href=https://github.com/influxdata/helm-charts target=_blank rel="noopener noreffer">helm chart repo</a> and add to helm:</h3><pre><code>helm repo add influxdata https://helm.influxdata.com/
</code></pre><h3 id=2-deploy-influxdb2>2. Deploy Influxdb2</h3><p>No settings need to be adjusted:</p><p><code>helm upgrade --install influx2 influxdata/influxdb2</code></p><p>But you should note down the password for the admin user:</p><p><code>echo $(kubectl get secret influx2-influxdb2-auth -o "jsonpath={.data['admin-password']}" --namespace tick | base64 --decode)</code></p><p>To open the Influx UI, do:</p><p><code>kubectl port-forward svc/influx2-influxdb2 8081:80</code></p><p>Now, you can open <code>localhost:8081</code> and log in with user: admin and the before copied password.</p><h3 id=3-add-telegraf-configuration-in-influxdb>3. Add Telegraf Configuration in Influxdb</h3><p>In the UI sidebar, click <code>Data</code> and add &ldquo;Telegraf Configuration&rdquo;. Choose Kubernetes and enter a name: (e.g <code>telegraf</code>).
Then, copy the API token.</p><h3 id=4-deploy-telegraf>4. Deploy Telegraf</h3><p>We choose the Daemonset <code>telegraf-ds</code>, because it is expected for the <code>Kuberntes input</code> plugin, which among many others observes the node and pod resources.
Now open the <code>values.yaml</code> and add the following information under <code>config.outputs</code>:</p><pre><code>    - influxdb_v2:
        urls:
          - &quot;http://influx2-influxdb2.tick.svc&quot;
        token: INSERT_TOKEN
        organization: &quot;influxdata&quot;
        bucket: &quot;default&quot;
</code></pre><p>The input plugins are configured by default.</p><p>Then deploy the chart:</p><pre><code>helm upgrade --install ds-telegraf influxdata/telegraf-ds -f values.yaml
</code></pre><h3 id=5-view-metrics-data>5. View metrics data</h3><p>If all went well, you should now receive metrics data and see them in the UI under <code>Explore</code>:</p><p><img loading=lazy decoding=async src=dashboard-memory-influx.png alt=dashboard-memory-influx.png title=dashboard-memory-influx.png></p><h3 id=6-connect-local-client-with-db>6. Connect local client with DB</h3><p>If you want to query the DB through a locally installed CLI client or their Go-client, you can use the port-forwarding from earlier and use this adress to connect:
<code>kubectl port-forward svc/influx2-influxdb2 8081:80</code>.</p><p>This step was not so intuitive to me, because in InfluxDb 1 the service exposed the 8086 port for this. But now the UI and the database connection are both reachable through this port.</p><p>To test the connection with the CLI you can use:</p><p><code>influx ping --host http://localhost:8081</code></p><p>This is all there is to it. If you have any questions or find that my tutorial got outdated, please contact me :)</p></div><div class=post style=padding-top:0><div class=post-share></div></div></div><div id=toc-final></div></article><div class="page single"><style type=text/css media=screen>.revue-embed{background:#0c2d48;font-family:lato,sans-serif;color:#fdfcfb;text-align:center;border-radius:10px;margin-bottom:50px}form{width:80%;margin:.5em auto}.revue-header{font-size:20px;text-transform:uppercase;letter-spacing:2px;padding-top:.5em}.revue-description{font-size:13px;letter-spacing:.3px;margin:0 0 20px}.revue-input{display:flex;align-items:center;padding-bottom:2em}.button{height:44px;border:none}#member_email{width:65%;font-size:14px;background:#fdfcfb;font-family:inherit;color:#737373;letter-spacing:1px;text-indent:5%;border-radius:5px 0 0 5px}#member_submit{width:35%;height:46px;font-size:14px;background:#2e8bc0;font-family:inherit;font-weight:700;color:inherit;letter-spacing:1px;border-radius:0 5px 5px 0;cursor:pointer;transition:background .3s ease-in-out}#member_submit:hover{background:#d45d7d}input:focus{outline:none;outline:2px solid #e86c8d;box-shadow:0 0 2px #e86c8d}</style><link href="https://fonts.googleapis.com/css?family=Lato:400,700" rel=stylesheet type=text/css><div id=revue-embed class=revue-embed><form action=https://www.getrevue.co/profile/astobbe/add_subscriber method=post id=revue-form name=revue-form target=_blank><div class=revue-header><p>Want to connect?</p></div><div class=revue-description><p>I invite you to my life-long learning journey. Get notified about new
posts and updates.</p></div><div class=revue-input><input type=email class=button name=member[email] id=member_email placeholder="Your email address...">
<input type=submit class=button name=member[subscribe] id=member_submit value=Subscribe></div></form></div></div></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.101.0">Hugo</a> | Theme - <a href="https://ublogger.netlify.app/?utm_source=https://astobbe.me/&utm_medium=footer&utm_campaign=config&utm_term=2.0.1" target=_blank title="uBlogger 2.0.1">uBlogger</a></div><div class=footer-line><i class="svg-icon icon-copyright"></i><span>2022</span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="svg-icon icon-arrow-up"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="svg-icon icon-comments-fixed"></i></a></div><script src=/lib/smooth-scroll/smooth-scroll.min.js></script><script src=/lib/autocomplete/autocomplete.min.js></script><script src=/lib/lunr/lunr.min.js></script><script src=/lib/clipboard/clipboard.min.js></script><script>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script src=/js/theme.min.js></script></body></html>