<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>[Tutorial]: Kubernetes stateful pod migration |</title><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content><meta name=twitter:title content="[Tutorial]: Kubernetes stateful pod migration"><meta name=twitter:description content><meta name=twitter:creator content="@astobbe_"><meta name=Description content><meta property="og:title" content="[Tutorial]: Kubernetes stateful pod migration"><meta property="og:description" content="This is an extensive tutorial on how to set up a Kubernetes cluster that supports pod migration.
Why Statelessness is the basic foundation for microservices run inside Kubernetes. Outside it&rsquo;s main application domain, the platform also appeals to the High Performance Computing (HPC) community for that infrastructure management can be delegated to cloud providers and it&rsquo;s on-demand scaling. The challenge is that HPC jobs are usually long running and stateful. Jobs such as simulations or optimization problems usually keep their state in memory and state checkpointing on disk is not always available."><meta property="og:type" content="article"><meta property="og:url" content="https://astobbe.me/posts/pod-migration/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-06T00:00:00+00:00"><meta property="article:modified_time" content="2022-04-06T00:00:00+00:00"><meta name=application-name content="Adrian's Site"><meta name=apple-mobile-web-app-title content="Adrian's Site"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=icon type=image/png sizes=192x192 href=/android-chrome-192x192.png><link rel=icon type=image/png sizes=512x512 href=/android-chrome-512x512.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://astobbe.me/posts/pod-migration/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"[Tutorial]: Kubernetes stateful pod migration","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/astobbe.me\/posts\/pod-migration\/"},"genre":"posts","wordCount":2722,"url":"https:\/\/astobbe.me\/posts\/pod-migration\/","datePublished":"2022-04-06T00:00:00+00:00","dateModified":"2022-04-06T00:00:00+00:00","description":""}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https:\/\/astobbe.me\/"},{"@type":"ListItem","position":2,"name":"Programming","item":"https://astobbe.me/categories/programming/"},{"@type":"ListItem","position":3,"name":"[Tutorial]: Kubernetes stateful pod migration"}]}</script></head><body data-header-desktop data-header-mobile><script>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Adrian's Site" class="header-logo logo-svg">Adrian's Site</a></div><div class=menu><nav><ul class=menu-inner><li><a class=menu-item href=/posts/>Posts</a></li><li><a class=menu-item href=/categories/book-notes/>Book notes</a></li><li><a class=menu-item href=/categories/letters/>Letters</a></li><li><a class=menu-item href=/cv/>Resume</a></li><li><a class=menu-item href=/now/>Now</a></li><li><a class=menu-item href=/about/>About</a></li></ul></nav><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><span class="svg-icon icon-search"></span></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><span class="svg-icon icon-cancel"></span></a>
<span class="search-button search-loading" id=search-loading-desktop><span class="svg-icon icon-loading"></span></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><span class="svg-icon icon-moon"></span></a></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Adrian's Site" class=header-logo>Adrian's Site</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><span class="svg-icon icon-search"></span></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><span class="svg-icon icon-cancel"></span></a>
<span class="search-button search-loading" id=search-loading-mobile><span class="svg-icon icon-loading"></span></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><nav><ul><li><a class=menu-item href=/posts/ title>Posts</a></li><li><a class=menu-item href=/categories/book-notes/ title>Book notes</a></li><li><a class=menu-item href=/categories/letters/ title>Letters</a></li><li><a class=menu-item href=/cv/ title>Resume</a></li><li><a class=menu-item href=/now/ title>Now</a></li><li><a class=menu-item href=/about/ title>About</a></li></ul></nav><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><span class="svg-icon icon-moon"></span></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class="container content-article theme-classic"><div class=toc id=toc-auto><div class=toc-title>Contents</div><div class=toc-content id=toc-content-auto></div></div><div class=header-post><div class=post-title><div class=post-all-meta><nav class=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/categories/programming/>Programming</a></li><li>[Tutorial]: Kubernetes stateful pod migration</li></ol></nav><h1 class="single-title flipInX">[Tutorial]: Kubernetes stateful pod migration</h1><div class=post-meta><div class=post-meta-line><span class=post-category><a href=/categories/programming/><i class="svg-icon icon-folder"></i>Programming</a>
</span><span class=post-meta-date><i class="svg-icon icon-clock"></i><time class=timeago datetime=2022-04-06>2022-04-06</time>
</span><span class=post-meta-words><i class="svg-icon icon-pencil"></i>2722 words</span>
<span class=post-meta-reading><i class="svg-icon icon-stopwatch"></i>13 minutes</span></div></div></div></div></div><article class="single toc-start"><div class="content-block content-block-first content-block-position"><div class=post><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#why>Why</a></li><li><a href=#status-quo>Status quo</a></li><li><a href=#goal>Goal</a></li><li><a href=#demo>Demo</a></li><li><a href=#1-cluster-setup>1. Cluster setup</a><ul><li><a href=#network-setup>Network setup</a></li><li><a href=#vm-provisioning>VM provisioning</a></li></ul></li><li><a href=#2-kernel-downgrade>2. Kernel downgrade</a><ul><li><a href=#worker>Worker</a></li></ul></li><li><a href=#3-install-prequisites>3. Install Prequisites</a><ul><li><a href=#master-node>Master node</a><ul><li><a href=#containerd--kubelet>Containerd + Kubelet</a></li><li><a href=#kubeadm>Kubeadm</a></li><li><a href=#kubectl>Kubectl</a></li></ul></li><li><a href=#worker-node>Worker node</a><ul><li><a href=#criu>CRIU</a></li><li><a href=#golang>Golang</a></li><li><a href=#containerd>Containerd</a><ul><li><a href=#install-dependencies>Install dependencies</a></li><li><a href=#systemd-service>Systemd service</a></li><li><a href=#build>Build</a></li></ul></li><li><a href=#update-systemd-svc-to-custom-binary>Update systemd svc to custom binary</a></li><li><a href=#configure-cni-plugins>Configure CNI plugins</a></li><li><a href=#kubelet>Kubelet</a></li><li><a href=#kubeadm-1>Kubeadm</a></li></ul></li></ul></li><li><a href=#4-kubernetes-bootstrapping>4. Kubernetes bootstrapping</a><ul><li><a href=#networking>Networking</a></li><li><a href=#kubeadm-init>Kubeadm init</a></li><li><a href=#verify-cluster-state>Verify cluster state</a></li><li><a href=#debugging>(Debugging)</a></li><li><a href=#join-worker>Join worker</a></li><li><a href=#copy-kubeconfig>Copy kubeconfig</a></li></ul></li><li><a href=#5-demo-test-migration>5. Demo (test migration)</a><ul><li><a href=#deploy-stateful-pod>Deploy stateful pod</a></li><li><a href=#clone-pod>Clone pod</a></li></ul></li><li><a href=#6-set-up-file-server>6. Set up file server</a><ul><li><a href=#important-warning>Important warning</a></li><li><a href=#steps>Steps</a></li></ul></li><li><a href=#development>Development</a></li><li><a href=#end>End</a></li></ul></nav></div></div><p>This is an extensive tutorial on how to set up a Kubernetes cluster that supports pod migration.</p><h2 id=why>Why</h2><p>Statelessness is the basic foundation for microservices run inside Kubernetes. Outside it&rsquo;s main application domain, the platform also appeals to the High Performance Computing (HPC) community for that infrastructure management can be delegated to cloud providers and it&rsquo;s on-demand scaling. The challenge is that HPC jobs are usually long running and stateful. Jobs such as simulations or optimization problems usually keep their state in memory and state checkpointing on disk is not always available.
This is undesirable because failures are expected to occur.
Matters becomes even worse for jobs with unpredictable resource requirements. Unexpected spikes in memory can lead to out-of-memory node situations, which results in pods being killed. The catastrophic consequence is the complete loss of job progress from many hours or even days of compute time.
To avoid this, a migration of stateful pods to another node would be desirable.</p><h2 id=status-quo>Status quo</h2><p>Currently, Kubernetes does not support pod migration.
However, a PoC of a pod migration n prior work by <a href=https://www.researchgate.net/publication/349662156_Migrating_Pods_in_Kubernetes target=_blank rel="noopener noreffer">Jakob Schrettenbrunner</a> showed the feasibility. A <a href=https://github.com/kubernetes/enhancements/pull/1990 target=_blank rel="noopener noreffer">proposal</a> to support very basic checkpointing (forensic checkpoiting without restore) functionality has recently been accepted by the Kubernetes community as well and is expected to be available in future releases.</p><h2 id=goal>Goal</h2><p>Building on the prior PoC of Jakob Schrettenbrunner, I want to show you step by step how to set up a Kubernetes cluster with pod migration functionality. Bootstrapping a Kubernetes cluster from scratch is not a trivial task, but <code>kubeadm</code> will help us. Jakob also provided some <a href=https://docs.google.com/document/d/1E5p_FOHDGAp5YEQ23dCi9I8wPnMzd4aOazxI4uO_AMo/edit# target=_blank rel="noopener noreffer">documentation</a> on his setup and while very helpful it is far from complete and does not mention all potential gotchas. You might suspect already that this won&rsquo;t be a quick and easy process, but I hope to make it a lot easier for you through this extensive tutorial.</p><h2 id=demo>Demo</h2><p>To see what to expect, here is a quick demo of the steps to migrate a pod:</p><iframe width=560 height=315 src=https://www.youtube.com/embed/IPY852th_T0 title="YouTube video player" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><h2 id=1-cluster-setup>1. Cluster setup</h2><p>The cluster consists of 1 master node and 2 worker nodes. The VMs are provisioned in Microsoft Azure. For migrating the pod across a worker node, <a href="https://docs.microsoft.com/en-us/azure/storage/files/files-smb-protocol?tabs=azure-portal" target=_blank rel="noopener noreffer">Azure&rsquo;s SMB file share server</a>) is used. You might also use an NFS server (and it might even make things easier as mentioned later..), but this was not possible for company policy reasons in my case.</p><p>Kubernetes is bootstrapped using <code>kubeadm</code>. It&rsquo;s tested with version <code>v1.19.0-beta.0.1015+b521fb5114995f-dirty</code> ( binaries are available <a href=https://github.com/elchead/kubernetes/releases/tag/v8.1.0 target=_blank rel="noopener noreffer">here</a>, but I recommend building from source).</p><h3 id=network-setup>Network setup</h3><p>To set up the cluster network, I followed <a href=https://blog.nillsf.com/index.php/2021/10/29/setting-up-kubernetes-on-azure-using-kubeadm/ target=_blank rel="noopener noreffer">this tutorial</a>. You can use the web shell on Azure for this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>az group create -n kubeadm -l westus2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>az network vnet create <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --resource-group kubeadm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --name kubeadm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --address-prefix 192.168.0.0/16 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --subnet-name kube <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --subnet-prefix 192.168.0.0/16
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>az network nsg create <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --resource-group kubeadm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --name kubeadm
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>az network nsg rule create <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --resource-group kubeadm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --nsg-name kubeadm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --name kubeadmssh <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --protocol tcp <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --priority <span class=m>1000</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --destination-port-range <span class=m>22</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --access allow
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>az network nsg rule create <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --resource-group kubeadm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --nsg-name kubeadm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --name kubeadmWeb <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --protocol tcp <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --priority <span class=m>1001</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --destination-port-range <span class=m>6443</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --access allow
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>az network vnet subnet update <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -g kubeadm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -n kube <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --vnet-name kubeadm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --network-security-group kubeadm
</span></span><span class=line><span class=cl><span class=c1># load balancer:</span>
</span></span><span class=line><span class=cl>az network public-ip create <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --resource-group kubeadm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --name controlplaneip <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --sku Standard <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --dns-name nilfrankubeadm
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> az network lb create <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --resource-group kubeadm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --name kubemaster <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --sku Standard <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --public-ip-address controlplaneip <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --frontend-ip-name controlplaneip <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --backend-pool-name masternodes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>az network lb probe create <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --resource-group kubeadm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --lb-name kubemaster <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --name kubemasterweb <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --protocol tcp <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --port <span class=m>6443</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>az network lb rule create <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --resource-group kubeadm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --lb-name kubemaster <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --name kubemaster <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --protocol tcp <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --frontend-port <span class=m>6443</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --backend-port <span class=m>6443</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --frontend-ip-name controlplaneip <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --backend-pool-name masternodes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --probe-name kubemasterweb <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --disable-outbound-snat <span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --idle-timeout <span class=m>15</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --enable-tcp-reset <span class=nb>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>az network nic ip-config address-pool add <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --address-pool masternodes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --ip-config-name ipconfigkube-master-1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --nic-name kube-master-1VMNic <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --resource-group kubeadm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --lb-name kubemaster
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>az network nic ip-config address-pool add <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --address-pool masternodes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --ip-config-name ipconfigkube-master-2 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --nic-name kube-master-2VMNic <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --resource-group kubeadm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --lb-name kubemaster
</span></span></code></pre></td></tr></table></div></div><h3 id=vm-provisioning>VM provisioning</h3><p><strong>Master</strong></p><p>The specs of my master node VM are as follows on Ubuntu 21.04 (20.04 LTS could also be used):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;kube-master-3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;location&#34;</span><span class=p>:</span> <span class=s2>&#34;westeurope&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;ubuntu-21-04-lts&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;publisher&#34;</span><span class=p>:</span> <span class=s2>&#34;tidalmediainc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;product&#34;</span><span class=p>:</span> <span class=s2>&#34;ubuntu-21-04-lts&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;vmSize&#34;</span><span class=p>:</span> <span class=s2>&#34;Standard_D2ds_v4&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Worker</strong></p><p>Both worker VMs share the same specs:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;zone2/zone3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&#34;location&#34;</span><span class=p>:</span> <span class=s2>&#34;westeurope&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&#34;vmSize&#34;</span><span class=p>:</span> <span class=s2>&#34;Standard_E16-4ds_v4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&#34;imageReference&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&#34;publisher&#34;</span><span class=p>:</span> <span class=s2>&#34;canonical&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&#34;offer&#34;</span><span class=p>:</span> <span class=s2>&#34;0001-com-ubuntu-server-focal&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&#34;sku&#34;</span><span class=p>:</span> <span class=s2>&#34;20_04-lts-gen2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;latest&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>After connecting to the VM, go into root mode:
<code>sudo -s</code>
All following steps assume this!</p><h2 id=2-kernel-downgrade>2. Kernel downgrade</h2><h3 id=worker>Worker</h3><p>As mentioned <a href=https://github.com/checkpoint-restore/criu/issues/860 target=_blank rel="noopener noreffer">here</a>, recent Ubuntu kernels broke compatibility with CRIU.
Hence we downgrade the kernel:
<code>apt install -y linux-image-unsigned-5.4.0-1068-azure</code></p><p>Follow <a href=https://meetrix.io/blog/aws/changing-default-ubuntu-kernel.html target=_blank rel="noopener noreffer">these steps</a> to change the boot kernel.</p><h2 id=3-install-prequisites>3. Install Prequisites</h2><h3 id=master-node>Master node</h3><h4 id=containerd--kubelet>Containerd + Kubelet</h4><p>On the master node, you can install the official releases:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg <span class=p>|</span> sudo apt-key add -
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;deb https://apt.kubernetes.io/ kubernetes-xenial main&#34;</span> <span class=p>|</span> sudo tee /etc/apt/sources.list.d/kubernetes.list
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>apt update
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>apt install -y containerd kubelet
</span></span></code></pre></td></tr></table></div></div><p>But for safety, you should replace the <code>kubelet</code> with the binary path defined in the systemd service (<code>/usr/bin/kubelet</code>).
You can get the customized kubelet like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://github.com/elchead/kubernetes/releases/download/v8.1.0/kubelet
</span></span><span class=line><span class=cl>chmod +x ./kubelet
</span></span><span class=line><span class=cl>cp ./kubelet /usr/bin
</span></span></code></pre></td></tr></table></div></div><h4 id=kubeadm>Kubeadm</h4><p>To get the <code>kubeadm</code> version compatible with our modified kubernetes. Inside your home directory, do:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://github.com/elchead/kubernetes/releases/download/v8.1.0/kubeadm
</span></span><span class=line><span class=cl>chmod +x ./kubeadm
</span></span></code></pre></td></tr></table></div></div><h4 id=kubectl>Kubectl</h4><p>Install as described <a href=https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/ target=_blank rel="noopener noreffer">here</a></p><h3 id=worker-node>Worker node</h3><p>I recommend to perform the following steps in parallel on both worker VMs. You might use <a href=https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/01-prerequisites.md#running-commands-in-parallel-with-tmux target=_blank rel="noopener noreffer">tmux</a> or iTerm on Mac ( <code>Cmd+Shift+i</code>).</p><h4 id=criu>CRIU</h4><p>As described <a href="https://software.opensuse.org/download/package?package=criu&project=devel%3Atools%3Acriu" target=_blank rel="noopener noreffer">here</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;deb http://download.opensuse.org/repositories/devel:/tools:/criu/xUbuntu_20.04/ /&#39;</span> <span class=p>|</span> sudo tee /etc/apt/sources.list.d/devel:tools:criu.list
</span></span><span class=line><span class=cl>curl -fsSL https://download.opensuse.org/repositories/devel:tools:criu/xUbuntu_20.04/Release.key <span class=p>|</span> gpg --dearmor <span class=p>|</span> sudo tee /etc/apt/trusted.gpg.d/devel_tools_criu.gpg &gt; /dev/null
</span></span><span class=line><span class=cl>sudo apt update
</span></span><span class=line><span class=cl>sudo apt install -y criu
</span></span></code></pre></td></tr></table></div></div><p>Verify the version to be 3.16.1:
<code>criu --version</code></p><h4 id=golang>Golang</h4><p>Follow <a href=https://go.dev/doc/install target=_blank rel="noopener noreffer">here</a>. I installed v1.17.8:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://go.dev/dl/go1.17.8.linux-amd64.tar.gz
</span></span><span class=line><span class=cl>tar -C /usr/local -xzf go1.17.8.linux-amd64.tar.gz
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span><span class=nv>$PATH</span>:/usr/local/go/bin
</span></span></code></pre></td></tr></table></div></div><h4 id=containerd>Containerd</h4><h5 id=install-dependencies>Install dependencies</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>apt install btrfs-progs libbtrfs-dev runc
</span></span></code></pre></td></tr></table></div></div><h5 id=systemd-service>Systemd service</h5><p>I took the dirty path and used <code>apt</code> to install an official release :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>apt update
</span></span><span class=line><span class=cl>apt install containerd
</span></span></code></pre></td></tr></table></div></div><p>Then, I later replaced the binary defined in the systemd config with my fork binary.
The file looks like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat /lib/systemd/system/containerd.service
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Copyright The containerd Authors.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);</span>
</span></span><span class=line><span class=cl><span class=c1># you may not use this file except in compliance with the License.</span>
</span></span><span class=line><span class=cl><span class=c1># You may obtain a copy of the License at</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>#     http://www.apache.org/licenses/LICENSE-2.0</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Unless required by applicable law or agreed to in writing, software</span>
</span></span><span class=line><span class=cl><span class=c1># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span>
</span></span><span class=line><span class=cl><span class=c1># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span></span><span class=line><span class=cl><span class=c1># See the License for the specific language governing permissions and</span>
</span></span><span class=line><span class=cl><span class=c1># limitations under the License.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Unit<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Description</span><span class=o>=</span>containerd container runtime
</span></span><span class=line><span class=cl><span class=nv>Documentation</span><span class=o>=</span>https://containerd.io
</span></span><span class=line><span class=cl><span class=nv>After</span><span class=o>=</span>network.target local-fs.target
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Service<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>ExecStartPre</span><span class=o>=</span>-/sbin/modprobe overlay
</span></span><span class=line><span class=cl><span class=nv>ExecStart</span><span class=o>=</span>/usr/bin/containerd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>Type</span><span class=o>=</span>notify
</span></span><span class=line><span class=cl><span class=nv>Delegate</span><span class=o>=</span>yes
</span></span><span class=line><span class=cl><span class=nv>KillMode</span><span class=o>=</span>process
</span></span><span class=line><span class=cl><span class=nv>Restart</span><span class=o>=</span>always
</span></span><span class=line><span class=cl><span class=nv>RestartSec</span><span class=o>=</span><span class=m>5</span>
</span></span><span class=line><span class=cl><span class=c1># Having non-zero Limit*s causes performance problems due to accounting overhead</span>
</span></span><span class=line><span class=cl><span class=c1># in the kernel. We recommend using cgroups to do container-local accounting.</span>
</span></span><span class=line><span class=cl><span class=nv>LimitNPROC</span><span class=o>=</span>infinity
</span></span><span class=line><span class=cl><span class=nv>LimitCORE</span><span class=o>=</span>infinity
</span></span><span class=line><span class=cl><span class=nv>LimitNOFILE</span><span class=o>=</span>infinity
</span></span><span class=line><span class=cl><span class=c1># Comment TasksMax if your systemd version does not supports it.</span>
</span></span><span class=line><span class=cl><span class=c1># Only systemd 226 and above support this version.</span>
</span></span><span class=line><span class=cl><span class=nv>TasksMax</span><span class=o>=</span>infinity
</span></span><span class=line><span class=cl><span class=nv>OOMScoreAdjust</span><span class=o>=</span>-999
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Install<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>WantedBy</span><span class=o>=</span>multi-user.target
</span></span></code></pre></td></tr></table></div></div><h5 id=build>Build</h5><p>I recommend to build from source, but you may also use the binaries inside <code>bin</code>.</p><p>Clone my fork and checkout the <code>checkpoint</code> branch. If you want to use the version that only uploads a zip to the file server (please read under [6. Set up file server](#6. Set up file server), use <code>checkpoint-zip</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p /root/go/src/github.com/containerd <span class=o>&amp;&amp;</span> <span class=nb>cd</span> /root/go/src/github.com/containerd
</span></span><span class=line><span class=cl>git clone https://github.com/elchead/containerd.git
</span></span><span class=line><span class=cl><span class=nb>cd</span> containerd
</span></span><span class=line><span class=cl>git checkout checkpoint
</span></span></code></pre></td></tr></table></div></div><p>Build from source:
<code>make && make install</code></p><h4 id=update-systemd-svc-to-custom-binary>Update systemd svc to custom binary</h4><p>Stop the service:
`systemctl stop containerd</p><p>Inside root of the repository, do:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp ./bin/containerd /usr/bin/containerd
</span></span><span class=line><span class=cl>systemctl start containerd
</span></span></code></pre></td></tr></table></div></div><h4 id=configure-cni-plugins>Configure CNI plugins</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GOPATH</span><span class=o>=</span>/root/go
</span></span><span class=line><span class=cl>./script/setup/install-cni
</span></span></code></pre></td></tr></table></div></div><p>In the output the CNI version is set to 1.0.0 which is wrong. So we change it to a supported version such as 0.3.0 :
<code>vim /etc/cni/net.d/10-containerd-net.conflist</code></p><p>To be safe, restart the containerd service after after configuring the CNI plugins:
`systemctl restart containerd</p><h4 id=kubelet>Kubelet</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg <span class=p>|</span> sudo apt-key add -
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;deb https://apt.kubernetes.io/ kubernetes-xenial main&#34;</span> <span class=p>|</span> sudo tee /etc/apt/sources.list.d/kubernetes.list
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sudo apt update
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sudo apt -y install kubelet
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Then replace the binary:
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://github.com/elchead/kubernetes/releases/download/v8.1.0/kubelet
</span></span><span class=line><span class=cl>chmod +x ./kubelet
</span></span><span class=line><span class=cl>cp ./kubelet /usr/bin
</span></span></code></pre></td></tr></table></div></div><p>Modify the systemd service:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vim /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
</span></span><span class=line><span class=cl><span class=c1># Note: This dropin only works with kubeadm and kubelet v1.11+</span>
</span></span><span class=line><span class=cl><span class=o>[</span>Service<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># This is a file that &#34;kubeadm init&#34; and &#34;kubeadm join&#34; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span>
</span></span><span class=line><span class=cl><span class=nv>EnvironmentFile</span><span class=o>=</span>-/var/lib/kubelet/kubeadm-flags.env
</span></span><span class=line><span class=cl><span class=c1># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span>
</span></span><span class=line><span class=cl><span class=c1># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span>
</span></span><span class=line><span class=cl><span class=nv>EnvironmentFile</span><span class=o>=</span>-/etc/default/kubelet
</span></span><span class=line><span class=cl><span class=nv>ExecStart</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>ExecStart</span><span class=o>=</span>/usr/bin/kubelet <span class=nv>$KUBELET_KUBECONFIG_ARGS</span> <span class=nv>$KUBELET_CONFIG_ARGS</span> <span class=nv>$KUBELET_KUBEADM_ARGS</span> <span class=nv>$KUBELET_EXTRA_ARGS</span> --container-runtime-endpoint<span class=o>=</span>/run/containerd/containerd.sock --v<span class=o>=</span><span class=m>9</span> --read-only-port<span class=o>=</span><span class=m>0</span> --anonymous-auth<span class=o>=</span><span class=nb>true</span> --authorization-mode<span class=o>=</span>AlwaysAllow --container-runtime<span class=o>=</span>remote
</span></span><span class=line><span class=cl>~
</span></span></code></pre></td></tr></table></div></div><p>The kubelet config should look like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat /var/lib/kubelet/config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubelet.config.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>authentication</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>anonymous</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>webhook</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cacheTTL</span><span class=p>:</span><span class=w> </span><span class=l>0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>x509</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>clientCAFile</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/pki/ca.crt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>authorization</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>Webhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>webhook</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cacheAuthorizedTTL</span><span class=p>:</span><span class=w> </span><span class=l>0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cacheUnauthorizedTTL</span><span class=p>:</span><span class=w> </span><span class=l>0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusterDNS</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=m>10.96.0.10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusterDomain</span><span class=p>:</span><span class=w> </span><span class=l>cluster.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>cpuManagerReconcilePeriod</span><span class=p>:</span><span class=w> </span><span class=l>0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>evictionPressureTransitionPeriod</span><span class=p>:</span><span class=w> </span><span class=l>0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>fileCheckFrequency</span><span class=p>:</span><span class=w> </span><span class=l>0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>healthzBindAddress</span><span class=p>:</span><span class=w> </span><span class=m>127.0.0.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>healthzPort</span><span class=p>:</span><span class=w> </span><span class=m>10248</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>httpCheckFrequency</span><span class=p>:</span><span class=w> </span><span class=l>0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>imageMinimumGCAge</span><span class=p>:</span><span class=w> </span><span class=l>0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>KubeletConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>nodeStatusReportFrequency</span><span class=p>:</span><span class=w> </span><span class=l>0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>nodeStatusUpdateFrequency</span><span class=p>:</span><span class=w> </span><span class=l>0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resolvConf</span><span class=p>:</span><span class=w> </span><span class=l>/run/systemd/resolve/resolv.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rotateCertificates</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>runtimeRequestTimeout</span><span class=p>:</span><span class=w> </span><span class=l>50m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>staticPodPath</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/manifests</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>streamingConnectionIdleTimeout</span><span class=p>:</span><span class=w> </span><span class=l>0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>syncFrequency</span><span class=p>:</span><span class=w> </span><span class=l>0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumeStatsAggPeriod</span><span class=p>:</span><span class=w> </span><span class=l>0s</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>It&rsquo;s important to set the <code>runtimeRequestTimeout</code> to a higher value (default is 2 minutes), if you intend to migrate big containers (~50GB+)!</p><h4 id=kubeadm-1>Kubeadm</h4><p>Install as above for the master node:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>wget https://github.com/elchead/kubernetes/releases/download/v8.1.0/kubeadm
</span></span><span class=line><span class=cl>chmod +x ./kubeadm
</span></span></code></pre></td></tr></table></div></div><h2 id=4-kubernetes-bootstrapping>4. Kubernetes bootstrapping</h2><h3 id=networking>Networking</h3><p>First, we set up the networking and containerd.
I followed <a href=https://blog.nillsf.com/index.php/2021/10/29/setting-up-kubernetes-on-azure-using-kubeadm/ target=_blank rel="noopener noreffer">this tutorial</a>, but it might not be necessary:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf
</span></span></span><span class=line><span class=cl><span class=s>overlay
</span></span></span><span class=line><span class=cl><span class=s>br_netfilter
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sudo modprobe overlay
</span></span><span class=line><span class=cl>sudo modprobe br_netfilter
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Setup required sysctl params, these persist across reboots.</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
</span></span></span><span class=line><span class=cl><span class=s>net.bridge.bridge-nf-call-iptables  = 1
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.ip_forward                 = 1
</span></span></span><span class=line><span class=cl><span class=s>net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Apply sysctl params without reboot</span>
</span></span><span class=line><span class=cl>sudo sysctl --system
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sudo mkdir -p /etc/containerd
</span></span><span class=line><span class=cl>containerd config default <span class=p>|</span> sudo tee /etc/containerd/config.toml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sudo systemctl restart containerd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
</span></span></span><span class=line><span class=cl><span class=s>br_netfilter
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
</span></span></span><span class=line><span class=cl><span class=s>net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span class=line><span class=cl><span class=s>net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>sudo sysctl --system
</span></span></code></pre></td></tr></table></div></div><h3 id=kubeadm-init>Kubeadm init</h3><p>On the master node, create a config file in your home directory:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vim conf.yaml
</span></span><span class=line><span class=cl>apiServer:
</span></span><span class=line><span class=cl>  timeoutForControlPlane: 4m0s
</span></span><span class=line><span class=cl>apiVersion: kubeadm.k8s.io/v1beta2
</span></span><span class=line><span class=cl>imageRepository: sadrian99
</span></span><span class=line><span class=cl>kind: ClusterConfiguration
</span></span><span class=line><span class=cl>kubernetesVersion: v1.19.16
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>apiVersion: kubeadm.k8s.io/v1beta2
</span></span><span class=line><span class=cl>kind: InitConfiguration
</span></span><span class=line><span class=cl>nodeRegistration:
</span></span><span class=line><span class=cl>  criSocket: <span class=s2>&#34;/run/containerd/containerd.sock&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>Through this, the registry with the customized Kubernetes components will be used.</p><p>Then, start the cluster with:
<code>./kubeadm init --upload-certs --cri-socket "/run/containerd/containerd.sock" --config conf.yaml</code></p><p>Note: Ideally, the cluster is exposed with a DNS endpoint, but this did not work for me!</p><p>As the output indicates, perform:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>sudo cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</span></span></code></pre></td></tr></table></div></div><p>Then, copy the output to join the cluster on a worker node. It looks like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubeadm join 192.168.0.7:6443 --token 90djfo.2386gkxicg6y2ywo <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --discovery-token-ca-cert-hash sha256:0834d5d47c16799e2b1b4df3431923570549fe903f9339f875dd1f2f9d2dd2ef
</span></span></code></pre></td></tr></table></div></div><p>Finally, set up CNI:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f <span class=s2>&#34;https://cloud.weave.works/k8s/net?k8s-version=1.19&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=verify-cluster-state>Verify cluster state</h3><p><code>kubectl get node -w</code>
Should show a ready node after a few seconds.</p><p><code>kubectl get po -A</code>
Should show all pods running (including coredns!).</p><h3 id=debugging>(Debugging)</h3><p>If the node does not get ready, check the logs of the kubelet:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>journalctl -u kubelet [-f]
</span></span></code></pre></td></tr></table></div></div><p>Or if you don&rsquo;t find any hints from there, look here:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>journalctl -u  containerd [-f]
</span></span></code></pre></td></tr></table></div></div><p>It happened to me, that I got the error <code>cni plugin not initialized</code>.
If this is the case, be sure to repeat step the CNI plugin installation from above again.</p><p>If a pod is not running, use <code>kubectl describe</code> to debug.</p><p>Otherwise, a cluster reset might also help:
<code>./kubeadm reset --cri-socket "/run/containerd/containerd.sock"</code></p><h3 id=join-worker>Join worker</h3><p>Install crictl as prequisite:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>VERSION=&#34;v1.23.0&#34;
</span></span><span class=line><span class=cl>wget https://github.com/kubernetes-sigs/cri-tools/releases/download/$VERSION/crictl-$VERSION-linux-amd64.tar.gz
</span></span><span class=line><span class=cl>sudo tar zxvf crictl-$VERSION-linux-amd64.tar.gz -C /usr/local/bin
</span></span><span class=line><span class=cl>rm -f crictl-$VERSION-linux-amd64.tar.gz
</span></span></code></pre></td></tr></table></div></div><p>On the worker node, run the previously copied join command.
You might need to add <code>--cri-socket "/run/containerd/containerd.sock"</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>./kubeadm join 192.168.0.7:6443 --token 90djfo.2386gkxicg6y2ywo     --discovery-token-ca-cert-hash sha256:0834d5d47c16799e2b1b4df3431923570549fe903f9339f875dd1f2f9d2dd2ef --cri-socket &#34;/run/containerd/containerd.sock&#34;
</span></span></code></pre></td></tr></table></div></div><p>To verify, go back to the master node and check that the new node appears ready.</p><h3 id=copy-kubeconfig>Copy kubeconfig</h3><p>Now, copy the kubeconfig from the master node (<code>$HOME/.kube/config</code>) to the worker node inside <code>config</code> and export it:
<code>export KUBECONFIG=$HOME/config</code></p><p>The migration PoC needs the kubeconfig inside a special directory:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>mkdir -p /var/lib/kubelet
</span></span><span class=line><span class=cl>cp $HOME/config /var/lib/kubelet/kubeconfig
</span></span></code></pre></td></tr></table></div></div><h2 id=5-demo-test-migration>5. Demo (test migration)</h2><h3 id=deploy-stateful-pod>Deploy stateful pod</h3><p>Now it&rsquo;s time to test the migration, with a simple memory allocating pod (here 50 MB):
<code>kubectl run counter1 --restart=Never --image "ghcr.io/schrej/podmigration-testapp:latest" -- -m 50</code>. It&rsquo;s important to set <code>restartPolicy:Never</code> to prevent the original container from restarting during migration (relevant for large migrations)!</p><p>Through <code>kubectl get po -owide</code>, you can get pod IP and increment a stateful counter.
Be sure to do this on the worker node:
<code>curl $POD_IP:8080</code>
Repeat the counter increment a few times, to validate the successful migration later.</p><h3 id=clone-pod>Clone pod</h3><p>The pod spec is identical, except that it has an additional field <code>spec.clonePod</code> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>counter1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mcounter1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clonePod</span><span class=p>:</span><span class=w> </span><span class=l>counter1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;50&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ghcr.io/schrej/podmigration-testapp:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>counter1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dnsPolicy</span><span class=p>:</span><span class=w> </span><span class=l>ClusterFirst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>The migration should be very fast.
Currently, the old pod gets broken during the migration. But the cloned pod should be running.
Requesting it&rsquo;s endpoint with <code>curl</code> should return a number bigger than 1. Voila - you have successfully cloned a stateful pod in Kubernetes!</p><h2 id=6-set-up-file-server>6. Set up file server</h2><h3 id=important-warning>Important warning</h3><p>I had consistency problems for bigger file uploads with SMB. The container restore command is issued 1 second after the disk checkpoint has been saved completely.
However, at this time not all files of the checkpoint directory were uploaded successfully.</p><p>I circumvented this problem by storing the checkpoint on local disk and only storing a zipped archive on the server.
The temporary local-disk location is <code>/var/lib/kubelet/check</code>. Since, the OS disk is usually only 30GB, you will need to create a symbolic link to a bigger disk. In my case, a temporary disk with 500GB was mounted in <code>/mnt</code>.
To solve this, do:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>rm -r /var/lib/kubelet/check/
</span></span><span class=line><span class=cl>ln -s /mnt /var/lib/kubelet/check
</span></span></code></pre></td></tr></table></div></div><p>Interestingly, the compression immensly reduced the checkpoint size for the simple example app. For 50GB of allocated memory, the compressed zip was only around 20MB!
This modification was done inside containerd in the branch <code>checkpoint-zip</code>.</p><h3 id=steps>Steps</h3><p>The procedure is specific to Azure and is well documented <a href="https://docs.microsoft.com/en-us/azure/storage/files/storage-how-to-use-files-linux?tabs=smb311" target=_blank rel="noopener noreffer">here</a>. The server should be mounted inside <code>/var/libe/kubelet/migration</code>. I used the static mount and my /etc/fstab entry looks like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>//SERVER_URL/checkpoints /var/lib/kubelet/migration cifs nofail,credentials=/etc/smbcredentials/STORAGECLASSNAME.cred,serverino,cache=none
</span></span></code></pre></td></tr></table></div></div><h2 id=development>Development</h2><p>If you want to develop further or quickly test changes, it is much easier to work with a local cluster.
Inside the kubernetes repo root, run:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>CONTAINER_RUNTIME=remote CONTAINER_RUNTIME_ENDPOINT=&#34;unix:///run/containerd/containerd.sock&#34; CGROUP_DRIVER=&#34;systemd&#34; KUBELET_AUTHORIZATION_WEBHOOK=&#34;false&#34; KUBELET_FLAGS=&#34;--read-only-port=0 --anonymous-auth=true --authorization-mode=AlwaysAllow&#34; ./hack/local-up-cluster.sh
</span></span></code></pre></td></tr></table></div></div><p>To read the logs for the kubelet, you can use: <code>tail -f /tmp/kubelet.log</code>.</p><h2 id=end>End</h2><p>I admit that this was a long tutorial and it&rsquo;s likely not everything went smooth while following along. If you are stuck at some step, you can contact me and I can try to help :)</p></div><div class=post style=padding-top:0><div class=post-share></div></div></div><div id=toc-final></div></article><div class=callout><div>✉️</div><div id=callout-inner><b>Do you want to connect?</b> Sign-Up to be notified about future posts:<div id=revue-embed><form action=https://www.getrevue.co/profile/astobbe/add_subscriber method=post id=revue-form name=revue-form target=_blank><div class=revue-form-group><label for=member_email>Email address</label>
<input class=revue-form-field placeholder="Your email address..." type=email name=member[email] id=member_email></div><div class=revue-form-group><label for=member_first_name>Name <span class=optional>(Optional)</span></label>
<input class=revue-form-field placeholder="First name... (Optional)" type=text name=member[first_name] id=member_first_name></div><div class=revue-form-actions><input type=submit value=Subscribe name=member[subscribe] id=member_submit></div><div class=revue-form-footer>By subscribing, you agree with Revue’s <a target=_blank href=https://www.getrevue.co/terms>Terms of Service</a> and <a target=_blank href=https://www.getrevue.co/privacy>Privacy Policy</a>.</div></div></div></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.97.3">Hugo</a> | Theme - <a href="https://ublogger.netlify.app/?utm_source=https://astobbe.me/&utm_medium=footer&utm_campaign=config&utm_term=2.0.1" target=_blank title="uBlogger 2.0.1">uBlogger</a></div><div class=footer-line><i class="svg-icon icon-copyright"></i><span>2022</span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="svg-icon icon-arrow-up"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="svg-icon icon-comments-fixed"></i></a></div><script src=/lib/smooth-scroll/smooth-scroll.min.js></script><script src=/lib/autocomplete/autocomplete.min.js></script><script src=/lib/lunr/lunr.min.js></script><script src=/lib/clipboard/clipboard.min.js></script><script>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script src=/js/theme.min.js></script></body></html>